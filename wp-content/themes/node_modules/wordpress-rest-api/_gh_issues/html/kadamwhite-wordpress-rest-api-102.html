<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <script type="text/javascript" src="lib/jquery.js"></script>
    <script type="text/javascript" src="lib/jquery.emoji.js"></script>
    <title>OAuth support</title>
  </head>
  <body>
    <div class="container">
      <header>
        <p>
          <span class="badge open">open</span>
          <span class="url">kadamwhite/wordpress-rest-api#102</span>
        </p>
        <h1>OAuth support</h1>
      </header>
      <div class="comments">
        <div class="comment">
          <div class="meta">
            <a class="person" href="https://github.com/CaptainN">CaptainN</a>
            <time>7/20/2015</time>
          </div>
          <div class="body">
            <p>Hi!</p>
<p>What&#39;s involved with making oauth work (either oauth1, for which there is a WP API plugin plugin, or OAuth 2 for which there is a standalone plugin) with this plugin instead of standard HTTP authentication?</p>
<p>Kevin N.</p>

          </div>
        </div>

        <div class="comment">
          <div class="meta">
            <a class="person" href="https://github.com/kadamwhite">
              kadamwhite
            </a>
            <time>7/21/2015</time>
          </div>
          <div class="body"><p>@CaptainN OAuth isn&#39;t currently supported by this library -- the basic process, if I understand it (and I&#39;ll be honest, I&#39;ve never used OAuth successfully without confusion) is that you&#39;d use the plugin to generate a key, then we&#39;d need to add a facility to this API to make a request with that key to get the token used to authenticate.</p>
<p>It&#39;s definitely something I&#39;d like to add, but I haven&#39;t had the time to get to it yet and adding media support (and more robustly supporting/testing against the WP-API 2.0 betas) are the priorities right now. If you&#39;ve got OAuth experience, or interest, I&#39;d love to get some help putting this in though</p>
</div>
        </div>
        <div class="comment">
          <div class="meta">
            <a class="person" href="https://github.com/mzalewski">
              mzalewski
            </a>
            <time>10/23/2015</time>
          </div>
          <div class="body"><p>I doubt anyone has used OAuth without confusion :) I&#39;ve managed to get OAuth working though, so I should be able to help out</p>
</div>
        </div>
        <div class="comment">
          <div class="meta">
            <a class="person" href="https://github.com/kadamwhite">
              kadamwhite
            </a>
            <time>10/23/2015</time>
          </div>
          <div class="body"><p>@mzalewski if you&#39;re interested, that would be excellent in the extreme!</p>
</div>
        </div>
        <div class="comment">
          <div class="meta">
            <a class="person" href="https://github.com/mzalewski">
              mzalewski
            </a>
            <time>10/28/2015</time>
          </div>
          <div class="body"><p>Getting there slowly, I&#39;ve got OAuth 1.0a working now. The only issue is that it requires user/browser authorization, so haven&#39;t quite figured out the best way to handle that. At the moment, I&#39;m assuming that part will be done by the time the API is called so we already have an access token - but I have example code that does the actual authentication. </p>
<p>I&#39;m planning to push it up tomorrow anyway so I&#39;ll let you know when it&#39;s up</p>
</div>
        </div>
        <div class="comment">
          <div class="meta">
            <a class="person" href="https://github.com/kadamwhite">
              kadamwhite
            </a>
            <time>10/28/2015</time>
          </div>
          <div class="body"><p>:+1: </p>
</div>
        </div>
        <div class="comment">
          <div class="meta">
            <a class="person" href="https://github.com/mzalewski">
              mzalewski
            </a>
            <time>10/29/2015</time>
          </div>
          <div class="body"><p>I&#39;ve added OAuth 1.0A support to my fork here: 
<a href="https://github.com/mzalewski/wordpress-rest-api">https://github.com/mzalewski/wordpress-rest-api</a></p>
<p>I&#39;m not 100% happy with it yet, but should hopefully give everyone a basic understanding of the direction I&#39;m going. I&#39;ve added some example code to the readme, so (hopefully) should be easy to understand if anyone wants to try it out</p>
</div>
        </div>
        <div class="comment">
          <div class="meta">
            <a class="person" href="https://github.com/kadamwhite">
              kadamwhite
            </a>
            <time>10/29/2015</time>
          </div>
          <div class="body"><p>Thanks, @mzalewski , I will check it out next week. I appreciate your sharing your efforts!</p>
</div>
        </div>
        <div class="comment">
          <div class="meta">
            <a class="person" href="https://github.com/kadamwhite">
              kadamwhite
            </a>
            <time>1/19/2016</time>
          </div>
          <div class="body"><p>I discussed the currently-supported OAuth flows with @rmccue today in slack; transcript below</p>
<blockquote>
<ul>
<li>rmccue [7:35 PM]  @kadamwhite: Go ahead and ask :simple_smile:</li>
<li>kadamwhite [7:37 PM]  @rmccue: :) Thanks. First off, is there any way, with the current oauth infrastructure, to have a completely server-side oauth process; i.e., without any need for the user to open a browser, assuming the app has previously had a key generated for it?</li>
<li>rmccue [7:38 PM]  Using OAuth, not really
[7:38] That&#39;s typically called &quot;one-legged&quot; OAuth, and the way it works is by having a pre-authorised key/secret
[7:38] Technically possible with the plugin, but you&#39;d need to write an addon plugin to add UI for it</li>
<li>kadamwhite [7:39 PM]  hmm. ok. So there&#39;s not really any solution right now where a server-side app could authenticate with the wp-api, even if that app has previously been authorized and the user has entered their credentials into something accessible to the app — true?
[7:39] I ask because the #1 request i&#39;ve gotten for the wp-api node client was oauth, but it sounds like that isn&#39;t really possible and that&#39;s frustrating.</li>
<li>rmccue [7:42 PM]  You could through an initial browser integration
[7:42] If you have a look at the example client, that spits out the key/secret at the end of the process, so they could run that then just copy that across
[7:43] But generally no, there&#39;s no server-server authentication right now
[7:43] The #core-passwords team is working on &quot;app passwords&quot;, which will help with that
[7:44] <a href="http://oauth1.wp-api.org/docs/advanced/Desktop.html">http://oauth1.wp-api.org/docs/advanced/Desktop.html</a> may also help</li>
<li>kadamwhite [7:44 PM]  how long-lived are the tokens?</li>
<li>rmccue [7:47 PM]  (Sorry, was just making a :coffee: )
[7:48] Currently, they do not expire
[7:48] That might change in the future, but 1.0a doesn&#39;t have a &quot;refresh&quot; mechanism, so you&#39;d need to re-auth from scratch
[7:48] The plugin also currently doesn&#39;t recognise if a client has already been authorised, which might change</li>
<li>kadamwhite [7:52 PM]  &gt; so you&#39;d need to re-auth from scratch in the event that you lose the token, you mean? given that it won&#39;t expire on its own. I&#39;m also uncertain about the nuance of &quot;the plugin doesn&#39;t currently recognize if a client has already been authorized&quot;</li>
<li>rmccue [7:52 PM]  If the plugin ​<em>did</em>​ expire tokens</li>
<li>kadamwhite [7:52 PM]  ah, i see</li>
<li>rmccue [7:52 PM]  Potentially could in the future, but the flow would suck</li>
<li>kadamwhite [7:52 PM]  nods</li>
<li>rmccue [7:53 PM]  And basically, when you send off an authorisation request to some OAuth providers, they&#39;ll tell you if you&#39;ve already been given a token/secret for the user, and just give that back to you
[7:53] The plugin currently doesn&#39;t do that, so you could end up with multiple tokens per user for the same app</li>
<li>kadamwhite [7:54 PM]  if they request more than one, you mean?</li>
<li>rmccue [7:54 PM]  That&#39;ll probably change, since there&#39;s no reason to do that</li>
<li>kadamwhite [7:54 PM]  if you re-use a token it should work?</li>
<li>rmccue [7:54 PM]  Yep
[7:54] Some client apps do the lazy thing and don&#39;t store user state
[7:54] They just reauthorise every time</li>
<li>kadamwhite [7:55 PM]  So, to recap: the best-case scenario for node-driven applications that wish to auth via oauth 1.0a would be,<ol>
<li>User creates an app secret etc using the oauth plugin&#39;s wp-admin screen under the &quot;users&quot; menu</li>
<li>App requests authentication; user is required to open a browser in some capacity in order to enter their credentials, there is no way for any purely server-side logic to inject those into the process without user interaction</li>
<li>Browser flow could end by displaying a token to the user that they can copy into their app&#39;s configuration file</li>
<li>App could henceforth use that token to auth directly, just for that user
missing anything?</li>
</ol>
</li>
<li>rmccue [7:56 PM]  Nope, sounds right to me</li>
<li>kadamwhite [7:56 PM]  I&#39;m glad to hear there&#39;s a group working on it because that&#39;s less than ideal, but I get how we&#39;re in this situation. Thanks for helping walk me through it.</li>
<li>rmccue [7:56 PM]  However, you ​<em>could</em>​ build a small plugin that essentially does 1-3 on the server</li>
<li>kadamwhite [7:56 PM]  howso…? thought you&#39;d said that wasn&#39;t an option</li>
<li>rmccue [7:56 PM]  Essentially, it&#39;d create the token and authorise it automatically
[7:57] <a href="https://wordpress.slack.com/archives/core-restapi/p1453250332004937">https://wordpress.slack.com/archives/core-restapi/p1453250332004937</a></li>
<li>kadamwhite [7:57 PM]  hmm, which server are we talking about, wp&#39;s or the app&#39;s?</li>
<li>rmccue [7:57 PM]  WP&#39;s</li>
<li>kadamwhite [7:57 PM]  ahh I misunderstood</li>
<li>rmccue [7:57 PM]  :simple_smile:
[7:57] Yeah, should have said &quot;provider&quot; instead</li>
<li>kadamwhite [7:57 PM]  I&#39;ll probably want to pick your brain about that as well, then, because that would be of major benefit</li>
<li>rmccue [7:57 PM]  Indeed</li>
<li>kadamwhite [7:58 PM]  for now, we&#39;re ostensibly waiting for company to come over (I have my doubts), so I need to run. Thanks for your time, Ryan!</li>
</ul>
</blockquote>
</div>
        </div>
        <div class="comment">
          <div class="meta">
            <a class="person" href="https://github.com/mzalewski">
              mzalewski
            </a>
            <time>1/19/2016</time>
          </div>
          <div class="body"><p>That server-side plugin sounds interesting, would you consider that? </p>
<p>oAuth 2.0 appears offer a few more options though - combined with the oAuth 2 plugin on WP.org (<a href="https://wp-oauth.com/knowledge-base/grant-types/">https://wp-oauth.com/knowledge-base/grant-types/</a>), it might be possible to connect via oAuth without requiring a redirect. </p>
</div>
        </div>
        <div class="comment">
          <div class="meta">
            <a class="person" href="https://github.com/mzalewski">
              mzalewski
            </a>
            <time>1/19/2016</time>
          </div>
          <div class="body"><p>What about simply exposing a way to hook into the Auth function and passing off authentication to third-party code/modules?</p>
<p>It could be the easiest option given the number of possible uses of this plugin (eg: web-based, desktop, library)</p>
</div>
        </div>
        <div class="comment">
          <div class="meta">
            <a class="person" href="https://github.com/kadamwhite">
              kadamwhite
            </a>
            <time>1/20/2016</time>
          </div>
          <div class="body"><p>Oauth support&#39;s the most common question we&#39;ve gotten, so ideally I&#39;d like to have something set up within the package itself. Lots of ways to move toward that, though! I finally reviewed the implementation you linked to, it&#39;s interesting -- could you walk me through the process of using it within your application&#39;s code?</p>
</div>
        </div>
        <div class="comment">
          <div class="meta">
            <a class="person" href="https://github.com/kadamwhite">
              kadamwhite
            </a>
            <time>1/21/2016</time>
          </div>
          <div class="body"><p>@mzalewski forgot to respond to the other part of your comment: I would 100% be interested in an add-on to provide <a href="https://wp-oauth.com/">https://wp-oauth.com/</a> compatibility for this client library, but I&#39;m hesitant to implement support for a non-WP-native, paid plugin into the core wordpress-rest-api package. I feel it would be better to hold out for the core-passwords team&#39;s app passwords, or to investigate writing a companion WP plugin to extend the 1.0a server to give access to the node client in the way discussed in the chat above.</p>
</div>
        </div>
        <div class="comment">
          <div class="meta">
            <a class="person" href="https://github.com/mzalewski">
              mzalewski
            </a>
            <time>1/21/2016</time>
          </div>
          <div class="body"><p>Fair enough - it definitely makes sense to support the official WP authentication methods out of the box.</p>
<p>I&#39;m happy to walk through my fork, but it&#39;s been a pretty busy week - I&#39;ll free up some time to go through it properly within the next 1-2 days</p>
<p>I&#39;ll give a basic overview (from memory):
I&#39;ve put most of the oAuth handling code into the oAuth1.js file, with some changes to WP-Request.js which passes URL signing off to the oAuth object.</p>
<p>Both Client ID and Client Secret are required parameters and are configured in WP. These, along with the  oAuth URLs provided by the API, are used to construct an OAuth object ( new WP.OAuth ) </p>
<h6 id="oauth-getauthorizeurl">oauth.getAuthorizeUrl</h6>
<p>Sends a request WP API and receives a &quot;request&quot; token which is used to sign the Authorize URL (URL provided to promise callback).</p>
<h6 id="user-redirect">User Redirect</h6>
<p>The User is then required to log in on the site at the provided URL</p>
<h6 id="oauth-getaccesstoken">oauth.getAccessToken</h6>
<p>The getAccessToken function can then be used by passing the OAuth Token and verification code. This function is responsible for sending the access/verify tokens to the server, and finally receiving an authenticated token. </p>
<p>Once we have that authenticated token, it is stored for future use and will be used to authenticate outgoing requests. </p>
<p>It uses the OAuth Node (node-oauth) library behind the scenes, so the documentation there may help - the code I&#39;ve written simply wraps node-oauth and attempts to integrate it into your functions.</p>
<p>Hopefully that helps understand what I&#39;ve done. </p>
<p>I also came across this while working on it: <a href="http://passportjs.org/">http://passportjs.org/</a> - It doesn&#39;t solve any of the issues around redirecting users, but from what I can tell it is a popular library for working with oAuth and could possibly save a lot of time? </p>
</div>
        </div>
        <div class="comment">
          <div class="meta">
            <a class="person" href="https://github.com/mzalewski">
              mzalewski
            </a>
            <time>1/21/2016</time>
          </div>
          <div class="body"><p>Sorry if it&#39;s confusing, even I am having trouble reading what I&#39;ve just written. 
I&#39;ll see if I can put together a diagram which should explain things more clearly</p>
</div>
        </div>
        <div class="comment">
          <div class="meta">
            <a class="person" href="https://github.com/kadamwhite">
              kadamwhite
            </a>
            <time>1/21/2016</time>
          </div>
          <div class="body"><p>@mzalewski no problem whatsoever, I appreciate it. I&#39;m going to have some concerted time to work on this in conjunction with the WP-API team at the feelingrestful.com event next week, so if you get a chance to go through it in more detail by Wednesday or so that&#39;d be very helpful; but as time permits this weekend or on the flight I&#39;ll take what you&#39;ve given me already and see what I can make of it!</p>
<p>Thanks a ton.</p>
</div>
        </div>
        <div class="comment">
          <div class="meta">
            <a class="person" href="https://github.com/mzalewski">
              mzalewski
            </a>
            <time>1/21/2016</time>
          </div>
          <div class="body"><p>Ok great - looks like it&#39;ll be a great event :) I&#39;ll definitely put some
time aside to go through it before then.</p>
<p>On Thu, Jan 21, 2016 at 4:51 PM, K.Adam White <a href="&#109;&#97;&#x69;&#108;&#x74;&#x6f;&#58;&#110;&#111;&#x74;&#x69;&#102;&#105;&#99;&#x61;&#x74;&#105;&#111;&#x6e;&#115;&#x40;&#103;&#105;&#116;&#x68;&#x75;&#98;&#x2e;&#99;&#111;&#109;">&#110;&#111;&#x74;&#x69;&#102;&#105;&#99;&#x61;&#x74;&#105;&#111;&#x6e;&#115;&#x40;&#103;&#105;&#116;&#x68;&#x75;&#98;&#x2e;&#99;&#111;&#109;</a>
wrote:</p>
<blockquote>
<p>@mzalewski <a href="https://github.com/mzalewski">https://github.com/mzalewski</a> no problem whatsoever, I
appreciate it. I&#39;m going to have some concerted time to work on this in
conjunction with the WP-API team at the feelingrestful.com event next
week, so if you get a chance to go through it in more detail by Wednesday
or so that&#39;d be very helpful; but as time permits this weekend or on the
flight I&#39;ll take what you&#39;ve given me already and see what I can make of it!</p>
<p>Thanks a ton.</p>
<p>—
Reply to this email directly or view it on GitHub
<a href="https://github.com/kadamwhite/wordpress-rest-api/issues/102#issuecomment-173476285">https://github.com/kadamwhite/wordpress-rest-api/issues/102#issuecomment-173476285</a>
.</p>
</blockquote>
</div>
        </div>
        <div class="comment">
          <div class="meta">
            <a class="person" href="https://github.com/mzalewski">
              mzalewski
            </a>
            <time>1/27/2016</time>
          </div>
          <div class="body"><p>Sorry - hope I&#39;m not too late.. Here is a basic overview of the process (found on another site).</p>
<p>The dashed lines represent server-to-server communication, and the solid lines are user/browser redirects.</p>
<p>I&#39;ll go through the steps in the image and try to match it up with the code I added.
Step A: This is the oauth1.getAuthorizeUrl call - it uses the client ID and secret to request a &quot;Request Token&quot;. The second part of this function then generates a URL for the user to visit.  </p>
<p>Step B: The user must navigate to the signed URL generated in Step A - either by redirect, or manual browser navigation. </p>
<p>Step C: The server (WP) will verify the Request token and generate a verification Token</p>
<p>Step D: Now we have a verification Token, it needs to be passed back to the Node App - either by redirect, or by asking the user to copy+paste it.</p>
<p>Step E: oauth1.getAccessToken will use the verification token to ask the server for an Access Token. </p>
<p>Step F+: Access Token is granted by the server and is used to sign all future requests.</p>
<p><img src="http://blogs.wrox.com/sites/default/files/users/17/image/figures%20ch6/531327%20f0602.png" alt="Overview"></p>
</div>
        </div>
        <div class="comment">
          <div class="meta">
            <a class="person" href="https://github.com/mzalewski">
              mzalewski
            </a>
            <time>1/27/2016</time>
          </div>
          <div class="body"><p>I&#39;ve also updated my repository with 2 examples (examples folder) - one is an express app which will redirect the user to WP to obtain authorization, the other asks the user to copy and paste URLs/tokens via the console</p>
</div>
        </div>
        <div class="comment">
          <div class="meta">
            <a class="person" href="https://github.com/justingreerbbi">
              justingreerbbi
            </a>
            <time>1/28/2016</time>
          </div>
          <div class="body"><p>I wanted to stop by and put in 2 cents! I am going to be putting a full strip down native WP version of WP OAuth Server which will be a bare bones server with no license or paid version. DB Structure will be merged to handle consumers just as the OAuth1.0a plugin does.</p>
<p>I am open for helping out where I can.</p>
</div>
        </div>
      </div>
    </div>

    <script type="text/javascript">
      $(document).ready(function(){
        $('.comment').each(function(i, d){
          $(d).emoji()
        })
      })
    </script>

  </body>
</html>
